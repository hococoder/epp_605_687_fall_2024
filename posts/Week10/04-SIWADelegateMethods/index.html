<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Mobile Application Development for the iOS Platform"/><link rel="canonical" href="https://hococoder.com/posts/Week10/04-SIWADelegateMethods"/><meta name="twitter:url" content="https://hococoder.com/posts/Week10/04-SIWADelegateMethods"/><meta name="og:url" content="https://hococoder.com/posts/Week10/04-SIWADelegateMethods"/><title>Week 10 - Sign in With Apple Delegate Methods | Mobile Application Development for the iOS Platform</title><meta name="twitter:title" content="Week 10 - Sign in With Apple Delegate Methods | Mobile Application Development for the iOS Platform"/><meta name="og:title" content="Week 10 - Sign in With Apple Delegate Methods | Mobile Application Development for the iOS Platform"/><meta name="description" content="A description of my first post."/><meta name="twitter:description" content="A description of my first post."/><meta name="og:description" content="A description of my first post."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="../../../styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Mobile Application Development for the iOS Platform"/></head><body><header><div class="wrapper"><a class="site-name" href="/">Mobile Application Development for the iOS Platform</a><nav><ul><li><a href="/epp_605_687_spring_2024/posts/Intro/About Me">AboutMe</a></li><li><a href="/epp_605_687_spring_2024/posts/Intro/Example App">ExampleApp</a></li><li><a href="/epp_605_687_spring_2024/posts/Week00/00-Week00Overview">Week0</a></li><li><a href="/epp_605_687_spring_2024/posts/Week01/00-Week01Overview">Week1</a></li><li><a href="/epp_605_687_spring_2024/posts/Week02/00-Week02Overview">Week2</a></li><li><a href="/epp_605_687_spring_2024/posts/Week03/00-Week03Overview">Week3</a></li><li><a href="/epp_605_687_spring_2024/posts/Week04/00-Week04Overview">Week4</a></li><li><a href="/epp_605_687_spring_2024/posts/Week05/00-Week05Overview">Week5</a></li><li><a href="/epp_605_687_spring_2024/posts/Week06/00-Week06Overview">Week6</a></li><li><a href="/epp_605_687_spring_2024/posts/Week07/00-Week07Overview">Week7</a></li><li><a href="/epp_605_687_spring_2024/posts/Week08/00-Week08Overview">Week8</a></li><li><a href="/epp_605_687_spring_2024/posts/Week09/00-Week09Overview">Week9</a></li><li><a href="/epp_605_687_spring_2024/posts/Week10/00-Week10Overview">Week10</a></li><li><a href="/epp_605_687_spring_2024/posts/Week11/00-Week11Overview">Week11</a></li><li><a href="/epp_605_687_spring_2024/posts/Week12/00-Week12Overview">Week12</a></li><li><a href="/epp_605_687_spring_2024/posts/Week13/00-Week13Overview">Week13</a></li></ul></nav></div></header><div class="wrapper"><h1>Week 10 - Sign in With Apple Delegate Methods</h1><p style="float: left">Previous:  <A HREF="../03-SIWASignIn/index.html">Sign in with Apple Sign In</A></p><p style="float: right">Next:  <A HREF="../05-SIWAStartup/index.html" class="nextModule">Sign in With Apple at Startup</A></p><BR/><BR/><center> <iframe width="1280" height="720" src="https://cdnapisec.kaltura.com/html5/html5lib/v2.81.2/mwEmbedFrame.php/p/1458241/uiconf_id/14487351/entry_id/1_lf7msyfw?wid=_1458241&iframeembed=true&playerId=kaltura_player&entry_id=1_lf7msyfw&flashvars[localizationCode]=en&amp;flashvars[leadWithHTML5]=true&amp;flashvars[sideBarContainer.plugin]=true&amp;flashvars[sideBarContainer.position]=left&amp;flashvars[sideBarContainer.clickToClose]=true&amp;flashvars[chapters.plugin]=true&amp;flashvars[chapters.layout]=vertical&amp;flashvars[chapters.thumbnailRotator]=false&amp;flashvars[streamSelector.plugin]=true&amp;flashvars[EmbedPlayer.SpinnerTarget]=videoHolder&amp;flashvars[dualScreen.plugin]=true&amp;flashvars[mediaProxy.preferedFlavorBR]=2500&amp;flashvars[Kaltura.addCrossoriginToIframe]=true&amp;flashvars[EmbedPlayer.NotPlayableDownloadLink]=true;&wid=1_abkvs1gz"allowfullscreen webkitallowfullscreen mozAllowFullScreen allow="autoplay *; fullscreen *; encrypted-media *" sandbox="allow-forms allow-same-origin allow-scripts allow-top-navigation allow-pointer-lock allow-popups allow-modals allow-orientation-lock allow-popups-to-escape-sandbox allow-presentation allow-top-navigation-by-user-activation" frameborder="0" title="Kaltura Player">
  </iframe>
</center><p>Let's build a helper class that adopts <code>ASAuthorizationControllerDelegate</code> . We'll use it to deal with the success and error conditions when authorizing, and also have it capture some information from the login - namely the full name and email of the user. We'll also have it publish whether sign in was successful by adopting the <code>ObservableObject</code> protocol.</p><pre><code><span class="keyword">class</span> SIWADelegateHelper: <span class="type">NSObject</span>, <span class="type">ASAuthorizationControllerDelegate</span>, <span class="type">ObservableObject</span> {

  <span class="keyword">public var</span> fullName: <span class="type">String</span> = <span class="string">""</span>
  <span class="keyword">public var</span> emailToUse: <span class="type">String</span> = <span class="string">""</span>
  <span class="keyword">@Published public var</span> isSignedIn: <span class="type">Bool</span> = <span class="keyword">false</span>
</code></pre><p>The success method that we want to implement is <code>authorizationController(controller:didCompleteWithAuthorization)</code>, which takes in an <code>ASAuthorziation</code> object that contains credential property, which allows you to determine whether you are logging in with an AppleID or stored iCloud password, and also contains information that you requested from the user such as their Full Name and Email address - we requested those data values in the last episode. We need to handle 2 cases for authorization - one if AppleID credentials are used, another if a username/password combination is used (we won't focus on this, instead leaving our attention to the AppleID case; if you allow for iCloud Keychain login in your app, you'll want to implement the proper behavior here).</p><pre><code>   <span class="keyword">func</span> authorizationController(controller: <span class="type">ASAuthorizationController</span>, didCompleteWithAuthorization authorization: <span class="type">ASAuthorization</span>) {
    <span class="keyword">switch</span> authorization.<span class="property">credential</span> {
    <span class="keyword">case let</span> appleIDCredential <span class="keyword">as</span> <span class="type">ASAuthorizationAppleIDCredential</span>:
    
    <span class="keyword">case let</span> passwordCredential <span class="keyword">as</span> <span class="type">ASPasswordCredential</span>:
      <span class="call">print</span>(<span class="string">"using password"</span>)
    <span class="keyword">default</span>:
        <span class="keyword">break</span>
    }
  }
</code></pre><p>In the body of the first case statement, we can get some information from the passed in <code>appleIDCredential</code>. Before we do that, there is a very important feature of the framework that you need to know how to handle. I mentioned earlier that the credential object comes back with the requested user information such as full name and email. However, this information is only included in the credential object on the <strong><em>first authentication request</em></strong>. Apple assumes that you will properly process that information on the first try, and never need it again. This means that your app needs to either have a successful entry into your remote user database (to register that user in your system), or temporarily store the data until it can make such a database insertion. This feature stresses the importance of handling conditions such as bad network connections and database connections in your code, and ensuring that before you throw a piece of data away that you've handled it appropriately. In that case statement, let's grab the information we need.</p><pre><code>     <span class="comment">// Create an account in your system.</span>
    <span class="keyword">let</span> userIdentifier = appleIDCredential.<span class="property">user</span>
    <span class="keyword">let</span> fullName = appleIDCredential.<span class="property">fullName</span>
    <span class="keyword">let</span> email = appleIDCredential.<span class="property">email</span>

    <span class="comment">// For the purpose of this demo app, store the `userIdentifier` in the keychain.</span>
    <span class="keyword">self</span>.<span class="call">saveUserInKeychain</span>(userIdentifier)

    <span class="comment">// For the purpose of this demo app, save the name and email for eventual display in the app</span>
    <span class="keyword">if let</span> givenName = fullName?.<span class="property">givenName</span> {
      <span class="keyword">self</span>.<span class="property">fullName</span> = givenName
    }
    <span class="keyword">if let</span> email = email {
       <span class="keyword">self</span>.<span class="property">emailToUse</span> = email
    }
    <span class="call">print</span>(<span class="string">"using apple id"</span>)
    <span class="keyword">self</span>.<span class="property">isSignedIn</span> = <span class="keyword">true</span>
</code></pre><p>Let's break that down</p><ul><li>The <code>userIdentifier</code> (which is unique for each user), <code>fullName</code> and <code>email</code> are grabbed from the <code>appleIDCredential</code>.</li><li>The <code>userIdentifier</code> is saved to the Keychain. We'll implement this method shortly</li><li>The user's given name is pulled from the <code>fullName</code> if it is not nil</li><li>The email is set locally if it is not nil</li><li>Our <code>@Published</code> value, <code>isSignedIn</code> which is used to signify whether the user has successfully signed in is set to true</li></ul><p>Something to note about the <code>userIdentifier</code> - it will match across all of the devices the user owns, and it will also be the same identifier across all of the apps associated with your TeamID. This means that if a user runs another app with the same TeamID, you already know the information required to identify them, and there isn't a need to ask them for it again. It can also be used as the unique token to register in your user registration system on your server, and if there isn't an instance of that identifier there, you know you're dealing with a new user.</p><p><code>authorizationController(controller:didCompleteWithError)</code> gets called when Sign in with Apple fails, and passes back an Error object, which you can use to relay information back to the user to explain why the sign in process failed. We won't be focusing on handling the error in this course, but in a production app, you should.</p><pre><code>   <span class="keyword">func</span> authorizationController(controller: <span class="type">ASAuthorizationController</span>, didCompleteWithError error: <span class="type">Error</span>) {
      <span class="call">print</span>(<span class="string">"error</span> \(error)<span class="string">"</span>)
  }
</code></pre><p>With those in place, let's swing back and implement the <code>saveUserInKeychain</code> method. This uses some code from the referenced Apple sample code to store the user identifier in the Keychain. This is beyond the scope of this class, however, so we won't go into the details here. We pass in our Sign in With Apple identifier and the <code>userIdentifier</code> we got back from the <code>appleIDCredential</code> object.</p><pre><code>   <span class="keyword">private func</span> saveUserInKeychain(<span class="keyword">_</span> userIdentifier: <span class="type">String</span>) {
      <span class="keyword">do</span> {
          <span class="keyword">try</span> <span class="type">KeychainItem</span>(service: <span class="string">"edu.jhu.ep.steele.josh.EPExampleAppF20.SignInWithApple.Details"</span>, account: <span class="string">"userIdentifier"</span>).<span class="call">saveItem</span>(userIdentifier)
      } <span class="keyword">catch</span> {
          <span class="call">print</span>(<span class="string">"Unable to save userIdentifier to keychain."</span>)
      }
  }
</code></pre><p>You need to make sure that the string "edu.jhu.ep.steele.josh.EPExampleAppF20.SignInWithApple.Details" (or whatever you use in the method call above) is also present in the 2 methods at the bottom of the <code>KeychainItem</code> file - this key is used to properly store values for your app in the Keychain.</p><p>OK, now with that out of the way, we can do one more thing to get us ready for using Sign in With Apple in our app.</p><p style="float: left">Previous:  <A HREF="../03-SIWASignIn/index.html">Sign in with Apple Sign In</A></p><p style="float: right">Next:  <A HREF="../05-SIWAStartup/index.html" class="nextModule">Sign in With Apple at Startup</A></p></div><footer><p>Generated with ❤️ using <a href="https://github.com/johnsundell/publish">Publish</a></p><p>© 2023-2024 Josh Steele (rsteele3@jhu.edu) <a href="mailto:"(rsteele3@jhu.edu)""></a></p><p>Last updated January 21, 2024 at 1:48 PM</p><p><a href="https://mastodon.social/@hococoder" target="_blank">My Mastodon</a> | <a href="https://github.com/hococoder" target="_blank">My GitHub</a> | <a href="https://ep.jhu.edu" target="_blank">Whiting School EPP</a> | <a href="https://canvas.jhu.edu" target="_blank">JHU Canvas</a></p></footer></body></html>